---

- name:  Instalación y configuración de Zabbix Agent2 para monitoreo de Docker
  hosts: redhat


  pre_tasks:
   - name: Instalar llave GPG
     ansible.builtin.rpm_key:
      key: https://repo.zabbix.com/RPM-GPG-KEY-ZABBIX-08EFA7DD
      state: present
     tags: 
     - hecho

  tasks:
   - name: Instalar repositorio zabbix
     ansible.builtin.yum:
      name: https://repo.zabbix.com/zabbix/6.4/rhel/9/x86_64/zabbix-release-6.4-1.el9.noarch.rpm
      state: present
     tags: 
     - hecho

   - name: Instalar Zabbix Agent2
     ansible.builtin.yum:
      name: zabbix-agent2
      state: present
     tags: 
     - hecho
  
   - name: Copiar archivo de configuracion zabbix-agent2
     ansible.builtin.copy:
      src: zabbix_agent2.conf
      dest: /etc/zabbix
     tags: 
     - hecho

   - name: Habilitar systemD en zabbix-agent2 para cada inicio
     ansible.builtin.command:
      cmd: systemctl enable zabbix-agent2
     tags: 
     - hecho

   - name: Reiniciar el servicio zabbix-agent2 para efectuar cambios en archivo de configuracion
     ansible.builtin.command:
      cmd: systemctl restart zabbix-agent2
     tags: 
     - hecho

   - name: Ejecutar reinicio de agente zabbix
     ansible.builtin.command:
      cmd: systemctl status zabbix-agent2
     register: status
    
   - name: Visualizar el resultado del reinicio de agente zabbix
     ansible.builtin.debug:
      msg: "{{status.stdout_lines}}"
  
   - name: Agregar usuario Zabbix a grupo Docker 
     ansible.builtin.command:
      cmd: usermod -a -G docker zabbix

   - name: Obtener informacion sobre grupos
     ansible.builtin.command:
      cmd: cat /etc/group
     register: zabbix
   
   - name: Visualizar si el usuario zabbix pertenece al grupo docker
     ansible.builtin.debug:
      msg: "{{zabbix.stdout_lines[58]}}"


- name: Configuración de host en frontend de Zabbix
